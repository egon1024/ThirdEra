name: Release

on:
  pull_request:
    types: [closed]

permissions:
  contents: write

jobs:
  release:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Create release
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';

            // Scan for bump directive at the beginning of a line
            // (same logic as version-preview workflow)
            let bumpType = null;
            for (const line of body.split('\n')) {
              const trimmed = line.trim().toLowerCase();
              if (trimmed.startsWith('#major')) { bumpType = 'major'; break; }
              if (trimmed.startsWith('#minor')) { bumpType = 'minor'; break; }
              if (trimmed.startsWith('#patch')) { bumpType = 'patch'; break; }
            }
            if (!bumpType) bumpType = 'minor';

            // Get the latest release to determine current version
            let currentVersion = '0.0.0';
            try {
              const { data: releases } = await github.rest.repos.listReleases({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 1
              });
              if (releases.length > 0) {
                currentVersion = releases[0].tag_name.replace(/^v/, '');
              }
            } catch (e) {
              core.info(`No releases found, defaulting to ${currentVersion}`);
            }

            // Calculate next version using semver
            const parts = currentVersion.split('.').map(Number);
            let [major, minor, patch] = parts;
            if (bumpType === 'major') { major++; minor = 0; patch = 0; }
            else if (bumpType === 'minor') { minor++; patch = 0; }
            else if (bumpType === 'patch') { patch++; }
            const nextVersion = `${major}.${minor}.${patch}`;

            // Build release notes
            const prUrl = pr.html_url;
            const prTitle = pr.title;
            const prNumber = pr.number;
            const prAuthor = pr.user.login;

            const releaseBody = [
              `## What's Changed`,
              '',
              `* ${prTitle} (#${prNumber}) by @${prAuthor}`,
              '',
              `**PR:** ${prUrl}`,
              '',
              `---`,
              '',
              `| | Version |`,
              `|---|---|`,
              `| **Previous** | \`${currentVersion}\` |`,
              `| **This Release** | \`${nextVersion}\` |`,
              `| **Bump Type** | \`${bumpType}\` |`,
            ].join('\n');

            // Create the release and tag
            const { data: release } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: nextVersion,
              target_commitish: pr.merge_commit_sha,
              name: `v${nextVersion}`,
              body: releaseBody,
              draft: false,
              prerelease: false
            });

            core.info(`Release created: ${release.html_url}`);
