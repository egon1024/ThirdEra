<form class="{{cssClass}} flexcol" autocomplete="off">
    <header class="sheet-header">
        <img class="profile-img" src="{{item.img}}" data-edit="img" data-action="editImage" title="{{item.name}}" />
        <div class="header-fields">
            <h1 class="charname"><input name="name" type="text" value="{{item.name}}" placeholder="Class Name" /></h1>
        </div>
    </header>

    {{!-- Sheet Tab Navigation --}}
    <nav class="sheet-tabs tabs" data-group="primary">
        <a class="item {{#if (eq tabs.primary 'description')}}active{{/if}}" data-action="changeTab"
            data-group="primary" data-tab="description">Description</a>
        <a class="item {{#if (eq tabs.primary 'details')}}active{{/if}}" data-action="changeTab" data-group="primary"
            data-tab="details">Details</a>
        <a class="item {{#if (eq tabs.primary 'skills')}}active{{/if}}" data-action="changeTab" data-group="primary"
            data-tab="skills">Skills</a>
        <a class="item {{#if (eq tabs.primary 'features')}}active{{/if}}" data-action="changeTab" data-group="primary"
            data-tab="features">Features</a>
        <a class="item {{#if (eq tabs.primary 'spellcasting')}}active{{/if}}" data-action="changeTab" data-group="primary"
            data-tab="spellcasting">Spellcasting</a>
    </nav>

    <section class="sheet-body">
        {{!-- Description Tab --}}
        <div class="tab {{#if (eq tabs.primary 'description')}}active{{/if}}" data-group="primary"
            data-tab="description">
            <div class="editor-box">
                <prose-mirror name="system.description" data-document-u-u-i-d="{{item.uuid}}"
                    value="{{system.description}}" toggled="false">
                    {{{enriched.description}}}
                </prose-mirror>
            </div>
        </div>

        {{!-- Details Tab --}}
        <div class="tab details {{#if (eq tabs.primary 'details')}}active{{/if}}" data-group="primary"
            data-tab="details">
            <div class="form-group">
                <label>Hit Die</label>
                <select name="system.hitDie">
                    {{#each config.hitDice as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.hitDie)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
            </div>

            <div class="form-group">
                <label>BAB Progression</label>
                <select name="system.babProgression">
                    {{#each config.babProgressions as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.babProgression)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
            </div>

            <h3 class="form-header">Save Progressions</h3>
            <div class="form-group">
                <label>Fortitude</label>
                <select name="system.saves.fort">
                    {{#each config.saveProgressions as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.saves.fort)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group">
                <label>Reflex</label>
                <select name="system.saves.ref">
                    {{#each config.saveProgressions as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.saves.ref)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group">
                <label>Will</label>
                <select name="system.saves.will">
                    {{#each config.saveProgressions as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.saves.will)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
            </div>

            <h3 class="form-header">Other</h3>
            <div class="form-group">
                <label>Skill Points per Level</label>
                <input type="number" name="system.skillPointsPerLevel" value="{{system.skillPointsPerLevel}}"
                    data-dtype="Number" />
            </div>
            <div class="form-group">
                <label>Prestige Class</label>
                <select name="system.isPrestige">
                    <option value="false" {{#if (eq system.isPrestige "false" )}}selected{{/if}}>No</option>
                    <option value="true" {{#if (eq system.isPrestige "true" )}}selected{{/if}}>Yes</option>
                </select>
            </div>
        </div>

        {{!-- Skills Tab --}}
        <div class="tab skills {{#if (eq tabs.primary 'skills')}}active{{/if}}" data-group="primary" data-tab="skills">
            <h3 class="form-header">Class Skills</h3>
            <p class="hint">Drag skill items here to add them as class skills.</p>
            {{#if classSkillsForDisplay.length}}
            <ol class="skill-ref-list">
                {{#each classSkillsForDisplay as |entry|}}
                <li class="skill-ref-entry">
                    <span class="skill-ref-name">{{entry.displayName}}</span>
                    <a class="skill-ref-remove" data-action="removeClassSkill" data-skill-key="{{entry.key}}"
                        title="Remove"><i class="fas fa-times"></i></a>
                </li>
                {{/each}}
            </ol>
            {{else}}
            <p class="no-items hint">No class skills assigned</p>
            {{/if}}
        </div>

        {{!-- Features Tab --}}
        <div class="tab features {{#if (eq tabs.primary 'features')}}active{{/if}}" data-group="primary"
            data-tab="features">
            <h3 class="form-header">Class Features</h3>
            <p class="hint">Drag feat items here to assign as class features.</p>
            {{#if system.features.length}}
            <ol class="feature-list">
                {{#each system.features as |entry|}}
                <li class="feature-entry">
                    <span class="feature-level-badge">Lvl</span>
                    <input type="number" name="system.features.{{@index}}.level" value="{{entry.level}}" min="1"
                        data-dtype="Number" class="feature-level-input" />
                    <input type="hidden" name="system.features.{{@index}}.featItemId" value="{{entry.featItemId}}" />
                    <input type="hidden" name="system.features.{{@index}}.featName" value="{{entry.featName}}" />
                    <input type="hidden" name="system.features.{{@index}}.featKey" value="{{entry.featKey}}" />
                    <span class="feature-name">{{entry.featName}}</span>
                    <a class="feature-remove" data-action="removeFeature" data-feature-index="{{@index}}"
                        title="Remove"><i class="fas fa-times"></i></a>
                </li>
                {{/each}}
            </ol>
            {{else}}
            <p class="no-items hint">No class features assigned</p>
            {{/if}}

            <h3 class="form-header">Auto-Granted Feats</h3>
            <p class="hint">Feats granted when a character gains the given class level (level-up or Quick add).<br>
            <strong>Unconditional</strong>: always grant one feat.<br>
            <strong>Conditional</strong>: grant the first feat in the list the character doesn’t already have; if they have all, nothing is granted.</p>
            {{#if system.autoGrantedFeats.length}}
            <ol class="auto-granted-feats-list">
                {{#each system.autoGrantedFeats as |entry index|}}
                <li class="auto-granted-feat-entry">
                    <span class="feature-level-badge">Lvl</span>
                    <input type="number" name="system.autoGrantedFeats.{{index}}.level" value="{{entry.level}}" min="1" max="20"
                        data-dtype="Number" class="feature-level-input" />
                    {{#if entry.featUuid}}
                    <span class="auto-granted-type-label">Unconditional</span>
                    <select name="system.autoGrantedFeats.{{index}}.featUuid" class="auto-granted-feat-select">
                        <option value="">— Select feat —</option>
                        {{#each @root.availableFeats}}
                        <option value="{{uuid}}" {{#if (eq uuid ../entry.featUuid)}}selected{{/if}}>{{name}}</option>
                        {{/each}}
                    </select>
                    <a class="feature-remove" data-action="removeAutoGrantedFeat" data-auto-granted-index="{{index}}" title="Remove"><i class="fas fa-times"></i></a>
                    {{else}}
                    {{#if entry.featUuids.length}}
                    <div class="auto-granted-conditional-block">
                        <span class="auto-granted-type-label">Conditional</span>
                        <ol class="auto-granted-conditional-uuid-list">
                            {{#each entry.featUuids as |slotVal slotIdx|}}
                            <li class="auto-granted-conditional-uuid-entry">
                                <select name="system.autoGrantedFeats.{{entry._index}}.featUuids.{{slotIdx}}" class="auto-granted-feat-select">
                                    <option value="">— Select feat —</option>
                                    {{#each (lookup entry._featsForSlot slotIdx)}}
                                    <option value="{{uuid}}" {{#if (eq uuid slotVal)}}selected{{/if}}>{{name}}</option>
                                    {{/each}}
                                </select>
                                <a class="feature-remove" data-action="removeConditionalFeatUuid" data-entry-index="{{entry._index}}" data-uuid-index="{{slotIdx}}" title="Remove"><i class="fas fa-times"></i></a>
                            </li>
                            {{/each}}
                        </ol>
                        <button type="button" class="auto-granted-conditional-add" data-action="addConditionalFeatUuid" data-entry-index="{{entry._index}}"><i class="fas fa-plus"></i> Add feat to list</button>
                        <a class="feature-remove auto-granted-row-remove" data-action="removeAutoGrantedFeat" data-auto-granted-index="{{index}}" title="Remove row"><i class="fas fa-times"></i></a>
                    </div>
                    {{else}}
                    <div class="auto-granted-unconditional-block">
                        <button type="button" class="auto-granted-use-conditional" data-action="setAutoGrantedToConditional" data-entry-index="{{index}}">Use conditional instead</button>
                        <span class="auto-granted-type-label">Unconditional</span>
                        <select name="system.autoGrantedFeats.{{index}}.featUuid" class="auto-granted-feat-select">
                            <option value="">— Select feat —</option>
                            {{#each @root.availableFeats}}
                            <option value="{{uuid}}" {{#if (eq uuid ../entry.featUuid)}}selected{{/if}}>{{name}}</option>
                            {{/each}}
                        </select>
                    </div>
                    <a class="feature-remove" data-action="removeAutoGrantedFeat" data-auto-granted-index="{{index}}" title="Remove"><i class="fas fa-times"></i></a>
                    {{/if}}
                    {{/if}}
                </li>
                {{/each}}
            </ol>
            {{/if}}
            <button type="button" class="auto-granted-feat-add" data-action="addAutoGrantedFeat"><i class="fas fa-plus"></i> Add auto-granted feat</button>
        </div>

        {{!-- Spellcasting Tab --}}
        <div class="tab spellcasting {{#if (eq tabs.primary 'spellcasting')}}active{{/if}}" data-group="primary"
            data-tab="spellcasting">
            <h3 class="form-header">Spellcasting</h3>
            <div class="form-group">
                <label>
                    <input type="checkbox" name="system.spellcasting.enabled" {{checked system.spellcasting.enabled}}
                        data-dtype="Boolean" />
                    Spellcasting Enabled
                </label>
            </div>
            {{#if system.spellcasting.enabled}}
            <div class="form-group">
                <label>Spell List Key</label>
                <select name="system.spellcasting.spellListKey">
                    <option value="">—</option>
                    {{#each config.spellListKeys as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.spellcasting.spellListKey)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
                <p class="hint">Used to look up spell levels from spell items. Sorcerer and Wizard share "Sorcerer/Wizard".</p>
            </div>
            <div class="form-group">
                <label>Caster Type</label>
                <select name="system.spellcasting.casterType">
                    {{#each config.casterTypes as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.spellcasting.casterType)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group">
                <label>Preparation Type</label>
                <select name="system.spellcasting.preparationType">
                    {{#each config.preparationTypes as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.spellcasting.preparationType)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group">
                <label>Spell List Access</label>
                <select name="system.spellcasting.spellListAccess">
                    {{#each config.spellListAccessTypes as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.spellcasting.spellListAccess)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
                <p class="hint">Full list: access to all spells (cleric, druid, paladin, ranger). Learned: must learn spells via spellbook or spells known (wizard, sorcerer, bard).</p>
            </div>
            <div class="form-group">
                <label>Casting Ability</label>
                <select name="system.spellcasting.castingAbility">
                    {{#each config.castingAbilities as |label key|}}
                    <option value="{{key}}" {{#if (eq key ../system.spellcasting.castingAbility)}}selected{{/if}}>{{label}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group">
                <label>Domains Apply</label>
                <select name="system.spellcasting.supportsDomains">
                    <option value="false" {{#if (eq system.spellcasting.supportsDomains "false")}}selected{{/if}}>No</option>
                    <option value="true" {{#if (eq system.spellcasting.supportsDomains "true")}}selected{{/if}}>Yes</option>
                </select>
                <p class="hint">When Yes, the character sheet shows domain add/remove and domain spells for this class (e.g. Cleric).</p>
            </div>

            <h4 class="form-header">Spells Per Day</h4>
            <p class="hint">Enter the number of spells per day for each class level and spell level.</p>
            <div class="spells-per-day-table-container">
                <table class="spells-per-day-table">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>0</th>
                            <th>1st</th>
                            <th>2nd</th>
                            <th>3rd</th>
                            <th>4th</th>
                            <th>5th</th>
                            <th>6th</th>
                            <th>7th</th>
                            <th>8th</th>
                            <th>9th</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each spellsPerDayTable as |entry index|}}
                        <tr>
                            <td class="spells-per-day-level">{{entry.classLevel}}</td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel0" 
                                value="{{entry.spellLevel0}}" min="0" data-dtype="Number" class="spells-per-day-input" />
                                <input type="hidden" name="system.spellcasting.spellsPerDayTable.{{index}}.classLevel" value="{{entry.classLevel}}" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel1" 
                                value="{{entry.spellLevel1}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel2" 
                                value="{{entry.spellLevel2}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel3" 
                                value="{{entry.spellLevel3}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel4" 
                                value="{{entry.spellLevel4}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel5" 
                                value="{{entry.spellLevel5}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel6" 
                                value="{{entry.spellLevel6}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel7" 
                                value="{{entry.spellLevel7}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel8" 
                                value="{{entry.spellLevel8}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsPerDayTable.{{index}}.spellLevel9" 
                                value="{{entry.spellLevel9}}" min="0" data-dtype="Number" class="spells-per-day-input" /></td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>

            {{#if (eq system.spellcasting.preparationType "spontaneous")}}
            <h4 class="form-header">Spells Known</h4>
            <p class="hint">Optional. For spontaneous casters (e.g. Sorcerer, Bard), enter the maximum number of spells known per class level and spell level. Leave 0 for no limit.</p>
            <div class="spells-known-table-container">
                <table class="spells-known-table">
                    <thead>
                        <tr>
                            <th>Level</th>
                            <th>0</th>
                            <th>1st</th>
                            <th>2nd</th>
                            <th>3rd</th>
                            <th>4th</th>
                            <th>5th</th>
                            <th>6th</th>
                            <th>7th</th>
                            <th>8th</th>
                            <th>9th</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{#each spellsKnownTable as |entry index|}}
                        <tr>
                            <td class="spells-known-level">{{entry.classLevel}}</td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel0" value="{{entry.spellLevel0}}" min="0" data-dtype="Number" class="spells-known-input" /><input type="hidden" name="system.spellcasting.spellsKnownTable.{{index}}.classLevel" value="{{entry.classLevel}}" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel1" value="{{entry.spellLevel1}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel2" value="{{entry.spellLevel2}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel3" value="{{entry.spellLevel3}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel4" value="{{entry.spellLevel4}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel5" value="{{entry.spellLevel5}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel6" value="{{entry.spellLevel6}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel7" value="{{entry.spellLevel7}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel8" value="{{entry.spellLevel8}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                            <td><input type="number" name="system.spellcasting.spellsKnownTable.{{index}}.spellLevel9" value="{{entry.spellLevel9}}" min="0" data-dtype="Number" class="spells-known-input" /></td>
                        </tr>
                        {{/each}}
                    </tbody>
                </table>
            </div>
            {{/if}}

            {{#if (eq system.spellcasting.supportsDomains "true")}}
            <h4 class="form-header">Domains</h4>
            <p class="hint">Drag and drop domain items here to assign them to this class. Clerics typically have 2 domains.</p>
            {{#if system.spellcasting.domains.length}}
            <ol class="domains-list">
                {{#each system.spellcasting.domains as |domain index|}}
                <li class="domain-entry flexrow">
                    <div class="domain-name" style="flex: 1;">{{domain.domainName}}</div>
                    <div class="form-group" style="flex: 0 0 30px; margin: 0 0 0 8px;">
                        <a class="domain-remove" data-action="removeDomain" data-domain-key="{{domain.domainKey}}"
                            title="Remove Domain"><i class="fas fa-times"></i></a>
                    </div>
                </li>
                {{/each}}
            </ol>
            {{else}}
            <p class="no-items hint">No domains assigned. Drag domain items here to add them.</p>
            {{/if}}
            {{/if}}
            {{else}}
            <p class="hint">Enable spellcasting above to configure spellcasting options.</p>
            {{/if}}
        </div>
    </section>
</form>