<form class="{{cssClass}} flexcol" autocomplete="off">
  {{!-- Sheet Header --}}
  <header class="sheet-header sheet-header--character">
    <img class="profile-img" src="{{actor.img}}" data-edit="img" title="{{actor.name}}" height="100" width="100" />
    <div class="header-fields">
      <div class="charname-row">
        <h1 class="charname"><input name="name" type="text" value="{{actor.name}}" placeholder="Character Name" /></h1>
        <span class="actor-type-badge badge--character">PC</span>
      </div>
      <div class="resources grid grid-4col">
        <div class="resource flex-group-center">
          <label class="resource-label">Race</label>
          {{#if race}}
          <span class="race-name" data-action="openRace">{{race.name}}</span>
          <a class="race-remove" data-action="removeRace" title="Remove Race"><i class="fas fa-times"></i></a>
          {{else}}
          <span class="race-name race-empty">None</span>
          {{/if}}
        </div>
        <div class="resource flex-group-center">
          <label class="resource-label">Class</label>
          {{#if classSummary}}
          <span class="class-summary">{{classSummary}}</span>
          {{else}}
          <span class="class-summary class-empty">None</span>
          {{/if}}
        </div>
        <div class="resource flex-group-center">
          <label class="resource-label">Level</label>
          <span class="level-display">{{totalLevel}}</span>
        </div>
        <div class="resource flex-group-center">
          <label for="system.details.size" class="resource-label">Size</label>
          <select name="system.details.size">
            {{#each config.sizes as |label key|}}
            <option value="{{key}}" {{#if (eq key ../system.details.size)}}selected{{/if}}>{{label}}</option>
            {{/each}}
          </select>
        </div>
      </div>
    </div>
  </header>

  {{!-- Sheet Tab Navigation --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item {{#if (eq tabs.primary 'description')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="description">Description</a>
    <a class="item {{#if (eq tabs.primary 'abilities')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="abilities">Abilities</a>
    <a class="item {{#if (eq tabs.primary 'combat')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="combat">Combat</a>
    <a class="item {{#if (eq tabs.primary 'classes')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="classes">Classes</a>
    <a class="item {{#if (eq tabs.primary 'equipment')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="equipment">Equipment</a>
    <a class="item {{#if (eq tabs.primary 'spells')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="spells">Spells</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Description Tab --}}
    <div class="tab {{#if (eq tabs.primary 'description')}}active{{/if}}" data-group="primary" data-tab="description">
      <prose-mirror name="system.biography" data-document-u-u-i-d="{{actor.uuid}}" value="{{system.biography}}"
        toggled="false">
        {{{enriched.biography}}}
      </prose-mirror>
    </div>

    {{!-- Abilities Tab --}}
    <div class="tab abilities {{#if (eq tabs.primary 'abilities')}}active{{/if}}" data-group="primary"
      data-tab="abilities">

      {{!-- Ability Scores --}}
      <div class="abilities-header">
        <h3 class="items-header">Ability Scores</h3>
      </div>
      <div class="abilities-grid">
        <span class="abilities-col-header"></span>
        <span class="abilities-col-header">Base</span>
        <span class="abilities-col-header">Racial</span>
        <span class="abilities-col-header">Score</span>
        <span class="abilities-col-header">Mod</span>
        <span class="abilities-col-header"></span>

        {{#each system.abilities as |ability key|}}
        <h4 class="ability-name">{{lookup @root.abilityScores key}}</h4>
        <input type="text" name="system.abilities.{{key}}.value" value="{{ability.value}}" data-dtype="Number"
          placeholder="10" class="ability-base" />
        <span class="ability-racial">{{#if ability.racial}}{{signedNumber ability.racial}}{{/if}}</span>
        <span class="ability-effective">{{#if ability.racial}}{{ability.effective}}{{else}}{{ability.value}}{{/if}}</span>
        <span class="ability-mod {{#if (eq key 'dex')}}{{#if @root.dexCap.isCapped}}dex-capped{{/if}}{{/if}}">{{signedNumber ability.mod}}{{#if (eq key 'dex')}}{{#if @root.dexCap.isCapped}} <span class="dex-cap-note" title="Uncapped: {{signedNumber @root.dexCap.uncappedMod}} — limited by armor">(max)</span>{{/if}}{{/if}}</span>
        <a class="ability-check" data-action="abilityCheck" data-ability="{{key}}">
          <i class="fas fa-dice-d20"></i>
        </a>
        {{/each}}
      </div>

      {{!-- Saving Throws --}}
      <div class="saves-header">
        <h3 class="items-header">Saving Throws</h3>
      </div>
      <ol class="saves-list">
        {{#each system.saves as |save key|}}
        <li class="save flexrow">
          <h4 class="save-name">{{lookup @root.saves key}}</h4>
          {{#if @root.classes.length}}
          <span class="save-base" title="{{#each save.breakdown}}{{label}}: {{signedNumber value}}&#10;{{/each}}">{{save.base}}</span>
          {{else}}
          <input type="text" name="system.saves.{{key}}.base" value="{{save.base}}" data-dtype="Number"
            placeholder="0" />
          {{/if}}
          <span class="save-total">{{signedNumber save.total}}</span>
          <a class="save-roll" data-action="saveRoll" data-save="{{key}}">
            <i class="fas fa-dice-d20"></i>
          </a>
        </li>
        {{/each}}
      </ol>

      {{!-- Skills --}}
      <div class="skills-header">
        <h3 class="items-header">Skills</h3>
      </div>
      <ol class="items-list">
        {{#each skills as |item id|}}
        <li class="item flexrow" data-item-id="{{item._id}}">
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}</h4>
          </div>
          <div class="item-controls">
            <input type="text" name="system.ranks" value="{{item.system.ranks}}" data-dtype="Number" placeholder="0" />
            <span class="skill-total">{{signedNumber item.system.modifier.total}}</span>
            <a class="skill-check" data-action="skillCheck" title="Roll Skill"><i class="fas fa-dice-d20"></i></a>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>

      {{!-- Feats --}}
      <div class="feats-header">
        <h3 class="items-header">Feats</h3>
      </div>
      <ol class="items-list">
        {{#each feats as |item id|}}
        <li class="item flexrow" data-item-id="{{item._id}}">
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}</h4>
          </div>
          <div class="item-controls">
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>
    </div>

    {{!-- Combat Tab --}}
    <div class="tab combat {{#if (eq tabs.primary 'combat')}}active{{/if}}" data-group="primary" data-tab="combat">

      {{!-- Combat Stats --}}
      <div class="combat-stats">
        <div class="stat-block">
          <label>HP</label>
          <div class="stat-value">
            <input type="text" name="system.attributes.hp.value" value="{{system.attributes.hp.value}}"
              data-dtype="Number" />
            <span>/</span>
            <input type="text" name="system.attributes.hp.max" value="{{system.attributes.hp.max}}"
              data-dtype="Number" />
          </div>
        </div>
        <div class="stat-block">
          <label>Speed</label>
          <div class="stat-value {{#if speedInfo.isReduced}}value-modified{{/if}}">
            <span>{{system.attributes.speed.value}} ft</span>
            {{#if speedInfo.isReduced}}
            <span class="modified-note" title="Base speed: {{speedInfo.baseSpeed}} ft — reduced by armor">(reduced)</span>
            {{/if}}
          </div>
        </div>
        <div class="stat-block">
          <label>Initiative</label>
          <div class="stat-value">
            {{signedNumber system.attributes.initiative.bonus}}
          </div>
        </div>
        <div class="stat-block">
          <label>BAB</label>
          {{#if classes.length}}
          <div class="stat-value" title="{{#each system.combat.babBreakdown}}{{label}}: {{signedNumber value}}&#10;{{/each}}">
            {{signedNumber system.combat.bab}}
          </div>
          {{else}}
          <div class="stat-value">
            <input type="text" name="system.combat.bab" value="{{system.combat.bab}}" data-dtype="Number" />
          </div>
          {{/if}}
        </div>
      </div>

      {{!-- Attack Bonuses --}}
      <div class="attack-section">
        <div class="attack-grid">
          <span class="attack-col-header"></span>
          <span class="attack-col-header">BAB</span>
          <span class="attack-col-header">Ability</span>
          <span class="attack-col-header">Size</span>
          <span class="attack-col-header">Misc</span>
          <span class="attack-col-header">Total</span>

          <span class="attack-row-label">Melee</span>
          <span class="attack-cell">{{signedNumber system.combat.bab}}</span>
          <span class="attack-cell">{{signedNumber system.abilities.str.mod}} <span class="attack-ability-tag">STR</span></span>
          <span class="attack-cell">{{signedNumber system.combat.sizeMod}}</span>
          <input type="text" name="system.combat.meleeAttack.misc"
            value="{{system.combat.meleeAttack.misc}}" data-dtype="Number" class="attack-input" />
          <span class="attack-total">{{signedNumber system.combat.meleeAttack.total}}</span>

          <span class="attack-row-label">Ranged</span>
          <span class="attack-cell">{{signedNumber system.combat.bab}}</span>
          <span class="attack-cell">{{signedNumber system.abilities.dex.mod}} <span class="attack-ability-tag">DEX</span></span>
          <span class="attack-cell">{{signedNumber system.combat.sizeMod}}</span>
          <input type="text" name="system.combat.rangedAttack.misc"
            value="{{system.combat.rangedAttack.misc}}" data-dtype="Number" class="attack-input" />
          <span class="attack-total">{{signedNumber system.combat.rangedAttack.total}}</span>
        </div>
      </div>

      {{!-- AC Breakdown --}}
      <div class="ac-section">
        <div class="ac-totals">
          <div class="ac-total">
            <label>AC</label>
            <span class="ac-value">{{system.attributes.ac.value}}</span>
          </div>
          <div class="ac-total">
            <label>Touch</label>
            <span class="ac-value">{{system.attributes.ac.touch}}</span>
          </div>
          <div class="ac-total">
            <label>Flat-Footed</label>
            <span class="ac-value">{{system.attributes.ac.flatFooted}}</span>
          </div>
        </div>
        <ul class="ac-breakdown">
          <li>
            <span class="ac-breakdown-label">Base</span>
            <span class="ac-breakdown-value">10</span>
          </li>
          {{#each system.attributes.ac.breakdown as |entry|}}
          <li>
            <span class="ac-breakdown-label">{{entry.label}}</span>
            <span class="ac-breakdown-value">{{signedNumber entry.value}}</span>
          </li>
          {{/each}}
          <li>
            <span class="ac-breakdown-label">Misc</span>
            <input type="text" name="system.attributes.ac.misc" value="{{system.attributes.ac.misc}}"
              data-dtype="Number" class="ac-misc-input" />
          </li>
        </ul>
      </div>

      {{!-- Equipped Weapons --}}
      {{#if equippedWeapons.length}}
      <div class="items-header">
        <h3 class="items-header">Weapons</h3>
      </div>
      <ol class="items-list">
        {{#each equippedWeapons as |item id|}}
        <li class="item flexrow {{#if item.system.wielding}}{{#unless item.system.wielding.canWield}}size-mismatch{{/unless}}{{/if}}" data-item-id="{{item._id}}" {{#if item.system.wielding}}{{#unless item.system.wielding.canWield}}title="Cannot wield: {{item.system.properties.size}} weapon is too large/small for a {{../system.details.size}} character"{{/unless}}{{/if}}>
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}{{#unless (eq item.system.properties.size "Medium")}} <span class="item-size-label">({{item.system.properties.size}})</span>{{/unless}}</h4>
          </div>
          <div class="item-controls">
            {{#if item.system.twf.active}}
            <span class="item-detail value-modified" title="Two-weapon fighting penalty">{{signedNumber item.system.twf.penalty}} TWF</span>
            {{/if}}
            <span class="item-detail">{{item.system.damage.effectiveDice}}</span>
            {{#if item.system.wielding}}{{#if item.system.wielding.effectiveHandedness}}{{#unless (eq item.system.wielding.effectiveHandedness item.system.properties.handedness)}}<span class="item-detail value-modified" title="Base: {{lookup @root.config.weaponHandedness item.system.properties.handedness}} — shifted by size mismatch ({{item.system.wielding.attackPenalty}} attack)">{{lookup @root.config.weaponHandedness item.system.wielding.effectiveHandedness}}</span>{{/unless}}{{/if}}{{/if}}
            <a class="weapon-attack" data-action="weaponAttack" title="Attack"><i class="fas fa-dice-d20"></i></a>
            <a class="weapon-damage" data-action="weaponDamage" title="Damage"><i class="fas fa-dice-d6"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>
      {{/if}}

      {{!-- Equipped Armor --}}
      {{#if equippedArmor.length}}
      <div class="items-header">
        <h3 class="items-header">Armor</h3>
      </div>
      <ol class="items-list">
        {{#each equippedArmor as |item id|}}
        <li class="item flexrow equipped" data-item-id="{{item._id}}">
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}{{#unless (eq item.system.size "Medium")}} <span class="item-size-label">({{item.system.size}})</span>{{/unless}}</h4>
          </div>
          <div class="item-controls">
            <span class="item-detail">AC +{{item.system.armor.bonus}}</span>
          </div>
        </li>
        {{/each}}
      </ol>
      {{/if}}
    </div>

    {{!-- Classes Tab --}}
    <div class="tab classes {{#if (eq tabs.primary 'classes')}}active{{/if}}" data-group="primary" data-tab="classes">
      <div class="classes-header">
        <h3 class="items-header">Classes</h3>
        <a class="item-create" data-action="createItem" data-type="class"><i class="fas fa-plus"></i> Add Class</a>
      </div>
      {{#if classes.length}}
      <ol class="items-list classes-list">
        {{#each classes as |cls|}}
        <li class="item flexrow" data-item-id="{{cls._id}}">
          <div class="item-name">
            <div class="item-image"><img src="{{cls.img}}" title="{{cls.name}}" width="24" height="24" /></div>
            <h4 class="class-name-link" data-action="openClass">{{cls.name}}</h4>
          </div>
          <div class="item-controls">
            <a class="class-level-remove" data-action="removeClassLevel" title="Remove Level"><i class="fas fa-minus"></i></a>
            <span class="item-detail">Lvl {{cls.derivedLevels}}</span>
            <a class="class-level-add" data-action="addClassLevel" title="Add Level"><i class="fas fa-plus"></i></a>
            <span class="item-detail">{{cls.system.hitDie}}</span>
            <span class="item-detail">BAB: {{lookup @root.config.babProgressions cls.system.babProgression}}</span>
            <a class="item-edit" data-action="editItem" title="Edit Class"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Remove Class"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>
      {{else}}
      <p class="no-items hint">No classes — drag a class item here</p>
      {{/if}}
    </div>

    {{!-- Equipment Tab --}}
    <div class="tab equipment {{#if (eq tabs.primary 'equipment')}}active{{/if}}" data-group="primary" data-tab="equipment">
      {{!-- Weapons --}}
      <div class="items-header">
        <h3 class="items-header">Weapons</h3>
        <a class="item-create" data-action="createItem" data-type="weapon"><i class="fas fa-plus"></i> Add Weapon</a>
      </div>
      <ol class="items-list">
        {{#each weapons as |item id|}}
        <li class="item flexrow {{#if item.system.wielding}}{{#unless item.system.wielding.canWield}}size-mismatch{{/unless}}{{/if}}" data-item-id="{{item._id}}" {{#if item.system.wielding}}{{#unless item.system.wielding.canWield}}title="Cannot wield: {{item.system.properties.size}} weapon is too large/small for a {{../system.details.size}} character"{{/unless}}{{/if}}>
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}{{#unless (eq item.system.properties.size "Medium")}} <span class="item-size-label">({{item.system.properties.size}})</span>{{/unless}}</h4>
          </div>
          <div class="item-controls">
            {{!-- Hand assignment icons --}}
            <a class="weapon-hand {{#if (eq item.system.equipped 'primary')}}hand-active{{/if}}"
               data-action="equipWeaponHand" data-hand="primary"
               title="{{#if (eq item.system.equipped 'primary')}}Unequip{{else}}Equip Primary Hand{{/if}}">P</a>
            <a class="weapon-hand {{#if (eq item.system.equipped 'offhand')}}hand-active{{/if}}"
               data-action="equipWeaponHand" data-hand="offhand"
               title="{{#if (eq item.system.equipped 'offhand')}}Unequip{{else}}Equip Off-Hand{{/if}}">O</a>
            {{#if item.system.twf.active}}
            <span class="item-detail value-modified" title="Two-weapon fighting penalty">{{signedNumber item.system.twf.penalty}} TWF</span>
            {{/if}}
            <span class="item-detail">{{item.system.damage.effectiveDice}}</span>
            {{#if item.system.wielding}}{{#if item.system.wielding.effectiveHandedness}}{{#unless (eq item.system.wielding.effectiveHandedness item.system.properties.handedness)}}<span class="item-detail value-modified" title="Base: {{lookup @root.config.weaponHandedness item.system.properties.handedness}} — shifted by size mismatch ({{item.system.wielding.attackPenalty}} attack)">{{lookup @root.config.weaponHandedness item.system.wielding.effectiveHandedness}}</span>{{/unless}}{{/if}}{{/if}}
            <a class="weapon-attack" data-action="weaponAttack" title="Attack"><i class="fas fa-dice-d20"></i></a>
            <a class="weapon-damage" data-action="weaponDamage" title="Damage"><i class="fas fa-dice-d6"></i></a>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>

      {{!-- Armor --}}
      <div class="items-header">
        <h3 class="items-header">Armor</h3>
        <a class="item-create" data-action="createItem" data-type="armor"><i class="fas fa-plus"></i> Add Armor</a>
      </div>
      <ol class="items-list">
        {{#each armor as |item id|}}
        <li class="item flexrow {{#if (eq item.system.equipped 'true')}}equipped{{/if}} {{#unless (eq item.system.size ../system.details.size)}}size-mismatch{{/unless}}" data-item-id="{{item._id}}" {{#unless (eq item.system.size ../system.details.size)}}title="Size mismatch: armor is {{item.system.size}}, character is {{../system.details.size}}"{{/unless}}>
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}{{#unless (eq item.system.size "Medium")}} <span class="item-size-label">({{item.system.size}})</span>{{/unless}}</h4>
          </div>
          <div class="item-controls">
            <span class="item-detail">AC +{{item.system.armor.bonus}}</span>
            <a class="item-equip {{#if (eq item.system.equipped 'true')}}equipped{{else}}unequipped{{/if}}" data-action="toggleEquip" title="Toggle Equipped">
              <i class="{{#if (eq item.system.equipped 'true')}}fas fa-check-circle{{else}}far fa-circle{{/if}}"></i>
            </a>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>

      {{!-- Equipment --}}
      <div class="items-header">
        <h3 class="items-header">Equipment</h3>
        <a class="item-create" data-action="createItem" data-type="equipment"><i class="fas fa-plus"></i> Add
          Equipment</a>
      </div>
      <ol class="items-list">
        {{#each equipment as |item id|}}
        <li class="item flexrow" data-item-id="{{item._id}}">
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}</h4>
          </div>
          <div class="item-controls">
            <span class="item-detail">Qty: {{item.system.quantity}}</span>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>
    </div>

    {{!-- Spells Tab --}}
    <div class="tab spells {{#if (eq tabs.primary 'spells')}}active{{/if}}" data-group="primary" data-tab="spells">
      <div class="items-header">
        <h3 class="items-header">Spells</h3>
        <a class="item-create" data-action="createItem" data-type="spell"><i class="fas fa-plus"></i> Add Spell</a>
      </div>
      <ol class="items-list">
        {{#each spells as |item id|}}
        <li class="item flexrow" data-item-id="{{item._id}}">
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}</h4>
          </div>
          <div class="item-controls">
            <span class="item-detail">Level {{item.system.level}}</span>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>
    </div>

  </section>
</form>
