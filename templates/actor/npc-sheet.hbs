<form class="{{cssClass}} flexcol" autocomplete="off">
  {{!-- Sheet Header (aligned with PC: compact, key stats only) --}}
  <header class="sheet-header sheet-header--npc">
    <div class="sheet-header-images">
      <div class="sheet-header-image-block" title="{{localize 'THIRDERA.PortraitHint'}}">
        <label class="sheet-header-image-label">{{localize 'THIRDERA.Portrait'}}</label>
        <img class="profile-img" src="{{actor.img}}" data-edit="img" data-action="editImage" title="{{actor.name}}" height="100" width="100" />
      </div>
      {{#if showTokenImage}}
      <div class="sheet-header-image-block" title="{{localize 'THIRDERA.TokenImageHint'}}">
        <label class="sheet-header-image-label">{{localize 'THIRDERA.TokenImage'}}</label>
        <img class="profile-img token-img" src="{{tokenImg}}" data-action="editTokenImage" height="100" width="100" alt="" />
      </div>
      {{/if}}
    </div>
    <div class="header-fields">
      <div class="header-fields-main">
        <div class="charname-row">
          <h1 class="charname"><input name="name" type="text" value="{{actor.name}}" placeholder="NPC Name" /></h1>
          <span class="actor-type-badge badge--npc">NPC</span>
        </div>
        <div class="resources grid grid-4col">
          <div class="resource flex-group-center">
            <label class="resource-label">CR</label>
            <span class="header-cr-display">{{system.details.cr}}</span>
          </div>
          <div class="resource flex-group-center">
            <label class="resource-label">Size</label>
            <span class="header-size-display">{{#if system.details.size}}{{lookup config.sizes system.details.size}}{{else}}—{{/if}}</span>
          </div>
          <div class="resource flex-group-center header-hp">
            <label class="resource-label">HP</label>
            <div class="header-hp-display">
              <input type="number" data-header-hp value="{{system.attributes.hp.value}}"
                class="header-hp-current {{hpStatus}}" min="0" data-dtype="Number" />
              <span class="header-hp-sep">/</span>
              <span class="header-hp-max">{{system.attributes.hp.max}}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  {{!-- Sheet Tab Navigation (same order as PC where applicable) --}}
  <nav class="sheet-tabs tabs" data-group="primary">
    <a class="item {{#if (eq tabs.primary 'description')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="description">Description</a>
    <a class="item {{#if (eq tabs.primary 'abilities')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="abilities">{{localize 'THIRDERA.Attributes'}}</a>
    <a class="item {{#if (eq tabs.primary 'combat')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="combat">Combat</a>
    <a class="item {{#if (eq tabs.primary 'equipment')}}active{{/if}}" data-action="changeTab" data-group="primary"
      data-tab="equipment">Equipment</a>
  </nav>

  {{!-- Sheet Body --}}
  <section class="sheet-body">

    {{!-- Description Tab --}}
    <div class="tab {{#if (eq tabs.primary 'description')}}active{{/if}}" data-group="primary" data-tab="description">
      <div class="description-editor-box editor-box">
        <div class="editor-box-header flexrow">
          <label>{{localize 'THIRDERA.Description'}}</label>
          <button type="button" class="description-edit-btn editor-box-edit-btn" data-action="openDescriptionEditor" title="{{localize 'THIRDERA.Edit'}}">
            <i class="fas fa-pen-to-square"></i>
          </button>
        </div>
        <div class="description-view">{{{enriched.biography}}}</div>
        <prose-mirror name="system.biography" data-document-u-u-i-d="{{actor.uuid}}" value="{{system.biography}}"
          toggled="true">
          {{{enriched.biography}}}
        </prose-mirror>
      </div>
    </div>

    {{!-- Attributes Tab (with subtabs like PC) --}}
    <div class="tab abilities {{#if (eq tabs.primary 'abilities')}}active{{/if}}" data-group="primary"
      data-tab="abilities">

      {{!-- Subtab Navigation --}}
      <nav class="subtabs tabs" data-group="abilities">
        <a class="item {{#if (eq tabs.abilities 'details')}}active{{/if}}" data-action="changeTab" data-group="abilities"
          data-tab="details">{{localize 'THIRDERA.TabDetails'}}</a>
        <a class="item {{#if (eq tabs.abilities 'scores')}}active{{/if}}" data-action="changeTab" data-group="abilities"
          data-tab="scores">Scores & Saves</a>
      </nav>

      {{!-- Details Subtab: CR, Alignment, Size, Creature Type, Subtypes --}}
      <div class="subtab details-subtab {{#if (eq tabs.abilities 'details')}}active{{/if}}" data-group="abilities" data-tab="details">
        <div class="details-fields">
          <div class="details-field flexrow">
            <label for="system.details.cr" class="details-label">CR</label>
            <input type="text" name="system.details.cr" value="{{system.details.cr}}" data-dtype="String" class="details-input cr-input" maxlength="4" />
          </div>
          <div class="details-field flexrow">
            <label for="system.details.alignment" class="details-label">Alignment</label>
            <select name="system.details.alignment" id="system.details.alignment" class="details-input">
              {{#each config.alignments as |label key|}}
              <option value="{{key}}" {{#if (eq key ../system.details.alignment)}}selected{{/if}}>{{label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="details-field flexrow">
            <label for="system.details.size" class="details-label">{{localize 'THIRDERA.Size'}}</label>
            <select name="system.details.size" class="details-input">
              {{#each config.sizes as |label key|}}
              <option value="{{key}}" {{#if (eq key ../system.details.size)}}selected{{/if}}>{{label}}</option>
              {{/each}}
            </select>
          </div>
          <div class="details-field flexrow" data-drop-zone="creature-type">
            <label for="npc-creature-type-select" class="details-label">{{localize 'THIRDERA.NPC.CreatureType'}}</label>
            <select name="system.details.creatureTypeUuid" id="npc-creature-type-select" class="details-input creature-type-select" aria-label="{{localize 'THIRDERA.NPC.CreatureType'}}">
              <option value="">—</option>
              {{#each creatureTypeChoices as |choice|}}
              <option value="{{choice.uuid}}" {{#if (eq choice.uuid ../system.details.creatureTypeUuid)}}selected{{/if}}>{{choice.name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="details-field flexrow npc-subtypes-field">
            <label class="details-label">{{localize 'THIRDERA.NPC.Subtypes'}}</label>
            <div class="subtypes-controls" data-drop-zone="subtypes">
              <select class="subtype-add-select details-input" aria-label="{{localize 'THIRDERA.NPC.AddSubtype'}}">
                <option value="">— Add subtype —</option>
                {{#each subtypeChoices as |choice|}}
                <option value="{{choice.uuid}}">{{choice.name}}</option>
                {{/each}}
              </select>
              <a class="subtype-add-btn" data-action="addSubtype" title="{{localize 'THIRDERA.NPC.AddSubtype'}}"><i class="fas fa-plus"></i></a>
            </div>
          </div>
          {{#if selectedSubtypes.length}}
          <div class="details-field flexrow">
            <span class="details-label"></span>
            <ul class="subtypes-list">
              {{#each selectedSubtypes as |st|}}
              <li class="subtype-tag flexrow" data-subtype-uuid="{{st.uuid}}">
                <span class="subtype-name">{{st.name}}</span>
                <a class="subtype-remove" data-action="removeSubtype" title="{{localize 'THIRDERA.Remove'}}"><i class="fas fa-trash"></i></a>
              </li>
              {{/each}}
            </ul>
          </div>
          {{/if}}
        </div>
      </div>

      {{!-- Scores & Saves Subtab --}}
      <div class="subtab {{#if (eq tabs.abilities 'scores')}}active{{/if}}" data-group="abilities" data-tab="scores">
        {{!-- Ability Scores (grid aligned with PC: Base, Racial, Score, Mod, roller) --}}
        <div class="abilities-header">
          <h3 class="items-header">Ability Scores</h3>
        </div>
        <div class="abilities-grid">
          <span class="abilities-col-header"></span>
          <span class="abilities-col-header">Base</span>
          <span class="abilities-col-header">Racial</span>
          <span class="abilities-col-header">Score</span>
          <span class="abilities-col-header">Mod</span>
          <span class="abilities-col-header"></span>

          {{#each system.abilities as |ability key|}}
          <h4 class="ability-name">{{lookup @root.abilityScores key}}</h4>
          <input type="text" name="system.abilities.{{key}}.value" value="{{ability.value}}" data-dtype="Number"
            placeholder="10" class="ability-base" />
          <input type="text" name="system.abilities.{{key}}.racial" value="{{ability.racial}}" data-dtype="Number"
            placeholder="0" class="ability-racial-input" title="{{localize 'THIRDERA.NPC.RacialBonusHint'}}" />
          <span class="ability-effective">{{ability.effective}}</span>
          <span
            class="ability-mod {{#if (eq key 'dex')}}{{#if @root.dexCap.isOverloaded}}dex-overloaded{{else}}{{#if @root.dexCap.isCapped}}dex-capped{{/if}}{{/if}}{{/if}}"
            {{#if (eq key 'dex')}}{{#if @root.dexCap.isCapped}}title="Uncapped: {{signedNumber @root.dexCap.uncappedMod}} — limited by {{#if (eq @root.dexCap.reason 'both')}}armor and load{{else}}{{@root.dexCap.reason}}{{/if}} (Max Dex: {{#if (eq @root.dexCap.maxDex null)}}Unlimited{{else}}{{@root.dexCap.maxDex}}{{/if}})"
            {{/if}}{{/if}}>{{signedNumber ability.mod}}{{#if (eq key 'dex')}}{{#if @root.dexCap.isCapped}} <span
              class="dex-cap-note {{#if @root.dexCap.isOverloaded}}dex-overloaded{{/if}}">(max)</span>{{/if}}{{/if}}</span>
          <a class="ability-check" data-action="abilityCheck" data-ability="{{key}}">
            <i class="fas fa-dice-d20"></i>
          </a>
          {{/each}}
        </div>

        <div class="saves-header">
          <h3 class="items-header">Saving Throws</h3>
        </div>
        <ol class="saves-list">
          {{#each system.saves as |save key|}}
          <li class="save flexrow">
            <h4 class="save-name">{{lookup @root.saves key}}</h4>
            <input type="text" name="system.saves.{{key}}.base" value="{{save.base}}" data-dtype="Number" placeholder="0" />
            <span class="save-total">{{signedNumber save.total}}</span>
            <a class="save-roll rollable" data-action="saveRoll" data-save="{{key}}">
              <i class="fas fa-dice-d20"></i>
            </a>
          </li>
          {{/each}}
        </ol>
      </div>
    </div>

    {{!-- Combat Tab --}}
    <div class="tab combat {{#if (eq tabs.primary 'combat')}}active{{/if}}" data-group="primary" data-tab="combat">
      {{!-- Subtab Navigation --}}
      <nav class="subtabs tabs" data-group="combat">
        <a class="item {{#if (eq tabs.combat 'combat')}}active{{/if}}" data-action="changeTab" data-group="combat"
          data-tab="combat">{{localize 'THIRDERA.NPC.CombatSubtabCombat'}}</a>
        <a class="item {{#if (eq tabs.combat 'statblock')}}active{{/if}}" data-action="changeTab" data-group="combat"
          data-tab="statblock">{{localize 'THIRDERA.NPC.StatBlock'}}</a>
      </nav>

      {{!-- Combat Subtab: HP, Speed, Init, BAB, Attack grid, AC, Conditions --}}
      <div class="subtab combat-subtab {{#if (eq tabs.combat 'combat')}}active{{/if}}" data-group="combat" data-tab="combat">
      <div class="combat-stats">
        <div class="stat-block">
          <label>HP</label>
          <div class="stat-value">
            <input type="number" name="system.attributes.hp.value" value="{{system.attributes.hp.value}}"
              data-dtype="Number" class="{{hpStatus}}" min="-999" step="1" />
            <span>/</span>
            <input type="number" name="system.attributes.hp.max" value="{{system.attributes.hp.max}}"
              data-dtype="Number" min="1" step="1" />
          </div>
        </div>
        {{#if system.attributes.hp.dyingStableVisible}}
        <div class="stat-block hp-stable-block">
          <label class="checkbox-label">
            <input type="checkbox" name="system.attributes.hp.stable" {{checked system.attributes.hp.stable}}
              data-dtype="Boolean" />
            Stable
          </label>
          <span class="stat-hint">(when dying, −1 to −9 HP)</span>
        </div>
        {{/if}}
        <div class="stat-block">
          <label>Speed</label>
          <div class="stat-value {{#if speedInfo.reduced}}value-modified{{/if}}" {{#if speedInfo.reduced}}title="{{#if speedInfo.overloaded}}Overloaded! Maximum load exceeded — cannot move.{{else}}Reduced from {{speedInfo.baseSpeed}} ft by {{speedInfo.reason}}{{/if}}"{{/if}}>
            {{#if system.movementDisplayLine}}
            <span class="{{#if speedInfo.overloaded}}speed-overloaded{{else}}{{#if speedInfo.reduced}}speed-reduced{{/if}}{{/if}}">{{system.movementDisplayLine}}</span>
            {{#if speedInfo.reduced}}
            <span class="modified-note {{#if speedInfo.overloaded}}speed-overloaded{{/if}}">(land reduced)</span>
            {{/if}}
            {{else}}
            <span class="{{#if speedInfo.overloaded}}speed-overloaded{{else}}{{#if speedInfo.reduced}}speed-reduced{{/if}}{{/if}}">{{system.attributes.speed.value}} ft</span>
            {{#if speedInfo.reduced}}
            <span class="modified-note {{#if speedInfo.overloaded}}speed-overloaded{{/if}}">({{#if speedInfo.overloaded}}overloaded{{else}}reduced{{/if}})</span>
            {{/if}}
            {{/if}}
          </div>
        </div>
        <div class="stat-block">
          <label>Initiative</label>
          <div class="stat-value">{{signedNumber system.attributes.initiative.bonus}}</div>
        </div>
        <div class="stat-block">
          <label>BAB</label>
          <div class="stat-value">
            <input type="text" name="system.combat.bab" value="{{system.combat.bab}}" data-dtype="Number" />
          </div>
        </div>
      </div>

      {{!-- Compact natural attacks (roll only); edit on Stat block subtab --}}
      {{#if system.statBlock.naturalAttacks}}
      {{#if system.statBlock.naturalAttacks.length}}
      <div class="natural-attacks-compact">
        <h3 class="items-header">{{localize 'THIRDERA.NPC.NaturalAttacks'}}</h3>
        <ol class="natural-attacks-compact-list items-list">
          {{#each system.statBlock.naturalAttacks as |atk idx|}}
          <li class="natural-attack-compact flexrow" data-natural-attack-index="{{idx}}">
            <span class="natural-attack-compact-name">{{atk.name}}{{#unless atk.name}}—{{/unless}}</span>
            <span class="natural-attack-compact-total" title="{{#each atk.attackBreakdown}}{{label}}: {{signedNumber value}}&#10;{{/each}}">{{signedNumber atk.attackBonus}}</span>
            <a class="natural-attack-roll rollable" data-action="naturalAttackRollAttack" data-natural-attack-index="{{idx}}" title="{{localize 'THIRDERA.NPC.AttackRoll'}}"><i class="fas fa-dice-d20"></i></a>
            <a class="natural-attack-roll rollable" data-action="naturalAttackRollDamage" data-natural-attack-index="{{idx}}" title="{{localize 'THIRDERA.NPC.DamageRoll'}}"><i class="fas fa-dice-d6"></i></a>
          </li>
          {{/each}}
        </ol>
        <p class="natural-attacks-compact-hint">{{localize 'THIRDERA.NPC.NaturalAttacksEditHint'}}</p>
      </div>
      {{/if}}
      {{/if}}

      <div class="attack-section">
        <div class="attack-grid">
          <span class="attack-col-header"></span>
          <span class="attack-col-header">BAB</span>
          <span class="attack-col-header">Ability</span>
          <span class="attack-col-header">Size</span>
          <span class="attack-col-header">Misc</span>
          <span class="attack-col-header">Total</span>

          <span class="attack-row-label">Melee</span>
          <span class="attack-cell">{{signedNumber system.combat.bab}}</span>
          <span class="attack-cell">{{signedNumber system.abilities.str.mod}} <span class="attack-ability-tag">STR</span></span>
          <span class="attack-cell">{{signedNumber system.combat.sizeMod}}</span>
          <input type="text" name="system.combat.meleeAttack.misc" value="{{system.combat.meleeAttack.misc}}"
            data-dtype="Number" class="attack-input" />
          <span class="attack-total" title="{{#each system.combat.meleeAttack.breakdown}}{{label}}: {{signedNumber value}}&#10;{{/each}}">{{signedNumber system.combat.meleeAttack.total}}</span>

          <span class="attack-row-label">Ranged</span>
          <span class="attack-cell">{{signedNumber system.combat.bab}}</span>
          <span class="attack-cell">{{signedNumber system.abilities.dex.mod}} <span class="attack-ability-tag">DEX</span></span>
          <span class="attack-cell">{{signedNumber system.combat.sizeMod}}</span>
          <input type="text" name="system.combat.rangedAttack.misc" value="{{system.combat.rangedAttack.misc}}"
            data-dtype="Number" class="attack-input" />
          <span class="attack-total" title="{{#each system.combat.rangedAttack.breakdown}}{{label}}: {{signedNumber value}}&#10;{{/each}}">{{signedNumber system.combat.rangedAttack.total}}</span>
        </div>
      </div>

      <div class="ac-section">
        <div class="ac-totals">
          <div class="ac-total">
            <label>AC</label>
            <span class="ac-value">{{system.attributes.ac.value}}</span>
          </div>
          <div class="ac-total">
            <label>Touch</label>
            <span class="ac-value">{{system.attributes.ac.touch}}</span>
          </div>
          <div class="ac-total">
            <label>Flat-Footed</label>
            <span class="ac-value">{{system.attributes.ac.flatFooted}}</span>
          </div>
        </div>
        <ul class="ac-breakdown">
          <li>
            <span class="ac-breakdown-label">Base</span>
            <span class="ac-breakdown-value">10</span>
          </li>
          {{#each system.attributes.ac.breakdown as |entry|}}
          <li>
            <span class="ac-breakdown-label">{{entry.label}}</span>
            <span class="ac-breakdown-value">{{signedNumber entry.value}}</span>
          </li>
          {{/each}}
          <li>
            <span class="ac-breakdown-label">Misc</span>
            <input type="text" name="system.attributes.ac.misc" value="{{system.attributes.ac.misc}}"
              data-dtype="Number" class="ac-misc-input" />
          </li>
        </ul>
      </div>

      <div class="conditions-section">
        <div class="conditions-header">
          <h3 class="conditions-title">Conditions</h3>
          <div class="conditions-add">
            <select class="condition-add-select" aria-label="Add condition">
              <option value="">— Add condition —</option>
              {{#each conditionChoices as |choice|}}
              <option value="{{choice.conditionId}}">{{choice.name}}</option>
              {{/each}}
            </select>
            <a class="condition-add-btn" data-action="addCondition" title="Add selected condition"><i class="fas fa-plus"></i></a>
          </div>
        </div>
        {{#if activeConditions.length}}
        <ul class="conditions-list">
          {{#each activeConditions as |cond|}}
          <li class="condition flexrow" data-effect-id="{{cond.id}}">
            <img src="{{cond.img}}" alt="" width="24" height="24" class="condition-icon" />
            <span class="condition-name">{{cond.name}}{{#if cond.derivedFrom}} <span class="condition-derived" title="Derived from {{cond.derivedFrom}}">({{cond.derivedFrom}})</span>{{/if}}</span>
            {{#unless cond.derivedFrom}}<a class="condition-remove" data-action="removeCondition" data-effect-id="{{cond.id}}" title="Remove condition"><i class="fas fa-trash"></i></a>{{/unless}}
          </li>
          {{/each}}
        </ul>
        {{else}}
        <p class="conditions-empty">No conditions</p>
        {{/if}}
      </div>
      </div>
      {{!-- /Combat subtab --}}

      {{!-- Stat block Subtab: Natural armor, Space, Reach, Movement, Natural attacks --}}
      <div class="subtab statblock-subtab {{#if (eq tabs.combat 'statblock')}}active{{/if}}" data-group="combat" data-tab="statblock">
      <div class="npc-stat-block-section">
        <h3 class="items-header">{{localize 'THIRDERA.NPC.StatBlock'}}</h3>
        <div class="stat-block-fields">
          <div class="stat-block-field flexrow">
            <label for="system.statBlock.naturalArmor" class="details-label">{{localize 'THIRDERA.NPC.NaturalArmor'}}</label>
            <input type="number" name="system.statBlock.naturalArmor" value="{{#if system.statBlock}}{{system.statBlock.naturalArmor}}{{else}}0{{/if}}"
              data-dtype="Number" class="details-input" min="0" step="1" />
          </div>
          <div class="stat-block-field flexrow">
            <label for="system.statBlock.space" class="details-label">{{localize 'THIRDERA.NPC.Space'}}</label>
            <input type="text" name="system.statBlock.space" value="{{#if system.statBlock}}{{system.statBlock.space}}{{else}}5 ft{{/if}}"
              data-dtype="String" class="details-input" placeholder="5 ft" />
          </div>
          <div class="stat-block-field flexrow">
            <label for="system.statBlock.reach" class="details-label">{{localize 'THIRDERA.NPC.Reach'}}</label>
            <input type="text" name="system.statBlock.reach" value="{{#if system.statBlock}}{{system.statBlock.reach}}{{else}}5 ft{{/if}}"
              data-dtype="String" class="details-input" placeholder="5 ft" />
          </div>
          <div class="stat-block-movement-block">
            <h4 class="items-header">{{localize 'THIRDERA.NPC.Movement'}}</h4>
            {{#if system.movementDisplayLine}}
            <p class="stat-block-movement-display">{{system.movementDisplayLine}}</p>
            {{/if}}
            <div class="stat-block-movement-fields">
              <div class="stat-block-field flexrow">
                <label for="system.statBlock.movement.land" class="details-label">{{localize 'THIRDERA.NPC.MovementLand'}}</label>
                <input type="number" name="system.statBlock.movement.land" value="{{#if system.statBlock.movement}}{{system.statBlock.movement.land}}{{else}}0{{/if}}"
                  data-dtype="Number" class="details-input" min="0" step="1" placeholder="0 = use Speed above" title="{{localize 'THIRDERA.NPC.MovementLandHint'}}" />
              </div>
              <div class="stat-block-field flexrow">
                <label for="system.statBlock.movement.fly" class="details-label">{{localize 'THIRDERA.NPC.MovementFly'}}</label>
                <input type="number" name="system.statBlock.movement.fly" value="{{#if system.statBlock.movement}}{{system.statBlock.movement.fly}}{{else}}0{{/if}}"
                  data-dtype="Number" class="details-input" min="0" step="1" />
              </div>
              <div class="stat-block-field flexrow">
                <label for="system.statBlock.movement.flyManeuverability" class="details-label">{{localize 'THIRDERA.NPC.MovementFlyManeuverability'}}</label>
                <select name="system.statBlock.movement.flyManeuverability" class="details-input">
                  {{#each config.movementManeuverability as |label key|}}
                  <option value="{{key}}" {{#if (eq key (lookup (lookup ../system.statBlock 'movement') 'flyManeuverability'))}}selected{{/if}}>{{label}}</option>
                  {{/each}}
                </select>
              </div>
              <div class="stat-block-field flexrow">
                <label for="system.statBlock.movement.swim" class="details-label">{{localize 'THIRDERA.NPC.MovementSwim'}}</label>
                <input type="number" name="system.statBlock.movement.swim" value="{{#if system.statBlock.movement}}{{system.statBlock.movement.swim}}{{else}}0{{/if}}"
                  data-dtype="Number" class="details-input" min="0" step="1" />
              </div>
              <div class="stat-block-field flexrow">
                <label for="system.statBlock.movement.burrow" class="details-label">{{localize 'THIRDERA.NPC.MovementBurrow'}}</label>
                <input type="number" name="system.statBlock.movement.burrow" value="{{#if system.statBlock.movement}}{{system.statBlock.movement.burrow}}{{else}}0{{/if}}"
                  data-dtype="Number" class="details-input" min="0" step="1" />
              </div>
              <div class="stat-block-field flexrow">
                <label for="system.statBlock.movement.climb" class="details-label">{{localize 'THIRDERA.NPC.MovementClimb'}}</label>
                <input type="number" name="system.statBlock.movement.climb" value="{{#if system.statBlock.movement}}{{system.statBlock.movement.climb}}{{else}}0{{/if}}"
                  data-dtype="Number" class="details-input" min="0" step="1" />
              </div>
            </div>
          </div>
        </div>

        <div class="natural-attacks-block">
          <h4 class="items-header">{{localize 'THIRDERA.NPC.NaturalAttacks'}}</h4>
          {{#if system.statBlock.naturalAttacks}}
          {{#if system.statBlock.naturalAttacks.length}}
          <div class="natural-attacks-header">
            <span class="natural-attack-col-header">{{localize 'THIRDERA.NPC.NaturalAttackName'}}</span>
            <span class="natural-attack-col-header">{{localize 'THIRDERA.NPC.DamageDice'}}</span>
            <span class="natural-attack-col-header">{{localize 'THIRDERA.NPC.DamageType'}}</span>
            <span class="natural-attack-col-header">{{localize 'THIRDERA.NPC.Primary'}}</span>
            <span class="natural-attack-col-header">{{localize 'THIRDERA.NPC.AttackReach'}}</span>
            <span class="natural-attack-col-header">{{localize 'THIRDERA.NPC.AttackRoll'}}</span>
          </div>
          <ol class="natural-attacks-list items-list">
            {{#each system.statBlock.naturalAttacks as |atk idx|}}
            <li class="natural-attack" data-natural-attack-index="{{idx}}">
              <input type="text" name="system.statBlock.naturalAttacks.{{idx}}.name" value="{{atk.name}}"
                data-dtype="String" class="natural-attack-name" placeholder="—" title="{{localize 'THIRDERA.NPC.NaturalAttackName'}}" />
              <input type="text" name="system.statBlock.naturalAttacks.{{idx}}.dice" value="{{atk.dice}}"
                data-dtype="String" class="natural-attack-dice" placeholder="1d4" title="{{localize 'THIRDERA.NPC.DamageDice'}}" />
              <select name="system.statBlock.naturalAttacks.{{idx}}.damageType" class="natural-attack-type">
                {{#each @root.config.damageTypes as |label key|}}
                <option value="{{key}}" {{#if (eq key atk.damageType)}}selected{{/if}}>{{label}}</option>
                {{/each}}
              </select>
              <select name="system.statBlock.naturalAttacks.{{idx}}.primary" class="natural-attack-primary">
                <option value="true" {{#if (eq atk.primary "true")}}selected{{/if}}>{{localize 'THIRDERA.NPC.Primary'}}</option>
                <option value="false" {{#if (eq atk.primary "false")}}selected{{/if}}>{{localize 'THIRDERA.NPC.Secondary'}}</option>
              </select>
              <input type="text" name="system.statBlock.naturalAttacks.{{idx}}.reach" value="{{atk.reach}}"
                data-dtype="String" class="natural-attack-reach" placeholder="—" title="{{localize 'THIRDERA.NPC.AttackReach'}} (optional)" />
              <span class="natural-attack-total" title="{{#each atk.attackBreakdown}}{{label}}: {{signedNumber value}}&#10;{{/each}}">{{signedNumber atk.attackBonus}}</span>
              <div class="natural-attack-actions-row">
                <a class="natural-attack-roll rollable" data-action="naturalAttackRollAttack" data-natural-attack-index="{{idx}}" title="{{localize 'THIRDERA.NPC.AttackRoll'}}"><i class="fas fa-dice-d20"></i></a>
                <a class="natural-attack-roll rollable" data-action="naturalAttackRollDamage" data-natural-attack-index="{{idx}}" title="{{localize 'THIRDERA.NPC.DamageRoll'}}"><i class="fas fa-dice-d6"></i></a>
                <a class="natural-attack-delete" data-action="removeNaturalAttack" data-natural-attack-index="{{idx}}" title="{{localize 'THIRDERA.Remove'}}"><i class="fas fa-trash"></i></a>
              </div>
            </li>
            {{/each}}
          </ol>
          {{/if}}
          {{/if}}
          <div class="natural-attacks-add">
            <a class="natural-attack-add-btn" data-action="addNaturalAttack" title="{{localize 'THIRDERA.NPC.AddNaturalAttack'}}"><i class="fas fa-plus"></i> {{localize 'THIRDERA.NPC.AddNaturalAttack'}}</a>
          </div>
        </div>
      </div>
      </div>
      {{!-- /Stat block subtab --}}
    </div>

    {{!-- Equipment Tab --}}
    <div class="tab equipment {{#if (eq tabs.primary 'equipment')}}active{{/if}}" data-group="primary" data-tab="equipment">
      <div class="items-header">
        <h3 class="items-header">Weapons</h3>
      </div>
      <ol class="items-list">
        {{#each weapons as |item id|}}
        <li class="item flexrow {{#if item.system.wielding}}{{#unless item.system.wielding.canWield}}size-mismatch{{/unless}}{{/if}}"
          data-item-id="{{item._id}}" {{#if item.system.wielding}}{{#unless item.system.wielding.canWield}}title="Cannot wield: {{item.system.properties.size}} weapon is too large/small for a {{../system.details.size}} NPC"{{/unless}}{{/if}}>
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}{{#unless (eq item.system.properties.size "Medium")}} <span class="item-size-label">({{item.system.properties.size}})</span>{{/unless}}</h4>
          </div>
          <div class="item-controls">
            <a class="weapon-hand {{#if (eq item.system.equipped 'primary')}}hand-active{{/if}}" data-action="equipWeaponHand" data-hand="primary" title="{{#if (eq item.system.equipped 'primary')}}Unequip{{else}}Equip Primary Hand{{/if}}">P</a>
            <a class="weapon-hand {{#if (eq item.system.equipped 'offhand')}}hand-active{{/if}}" data-action="equipWeaponHand" data-hand="offhand" title="{{#if (eq item.system.equipped 'offhand')}}Unequip{{else}}Equip Off-Hand{{/if}}">O</a>
            {{#if item.system.twf.active}}
            <span class="item-detail value-modified" title="Two-weapon fighting penalty">{{signedNumber item.system.twf.penalty}} TWF</span>
            {{/if}}
            <span class="item-detail">{{item.system.damage.effectiveDice}}</span>
            {{#if item.system.wielding}}{{#if item.system.wielding.effectiveHandedness}}{{#unless (eq item.system.wielding.effectiveHandedness item.system.properties.handedness)}}<span class="item-detail value-modified" title="Base: {{lookup @root.config.weaponHandedness item.system.properties.handedness}} — shifted by size mismatch">{{lookup @root.config.weaponHandedness item.system.wielding.effectiveHandedness}}</span>{{/unless}}{{/if}}{{/if}}
            <a class="weapon-attack rollable" data-action="weaponAttack" title="Attack"><i class="fas fa-dice-d20"></i></a>
            <a class="weapon-damage rollable" data-action="weaponDamage" title="Damage"><i class="fas fa-dice-d6"></i></a>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>

      <div class="items-header">
        <h3 class="items-header">Armor</h3>
      </div>
      <ol class="items-list">
        {{#each armor as |item id|}}
        <li class="item flexrow {{#if (eq item.system.equipped 'true')}}equipped{{/if}} {{#unless (eq item.system.size ../system.details.size)}}size-mismatch{{/unless}}"
          data-item-id="{{item._id}}" {{#unless (eq item.system.size ../system.details.size)}}title="Size mismatch: armor is {{item.system.size}}, NPC is {{../system.details.size}}"{{/unless}}>
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}{{#unless (eq item.system.size "Medium")}} <span class="item-size-label">({{item.system.size}})</span>{{/unless}}</h4>
          </div>
          <div class="item-controls">
            <span class="item-detail">AC +{{item.system.armor.bonus}}</span>
            <a class="item-equip {{#if (eq item.system.equipped 'true')}}equipped{{else}}unequipped{{/if}}" data-action="toggleEquip" title="Toggle Equipped">
              <i class="{{#if (eq item.system.equipped 'true')}}fas fa-check-circle{{else}}far fa-circle{{/if}}"></i>
            </a>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}
      </ol>

      <div class="items-header">
        <h3 class="items-header">Equipment</h3>
      </div>
      <ol class="items-list">
        {{#each itemsNotInContainers.equipment as |item id|}}
        <li class="item flexrow draggable" data-item-id="{{item._id}}">
          <div class="item-name">
            <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
            <h4>{{item.name}}</h4>
          </div>
          <div class="item-controls">
            <span class="item-detail">Qty: {{item.system.quantity}}</span>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        {{/each}}

        {{#each containers as |container id|}}
        <li class="item flexrow container-item draggable container-capacity-{{container.capacityStatus}}{{#unless container.capacityStatus}} container-capacity-unlimited{{/unless}}" data-item-id="{{container._id}}" data-container-id="{{container._id}}">
          <div class="item-name">
            <div class="item-image"><img src="{{container.img}}" title="{{container.name}}" width="24" height="24" /></div>
            <h4>
              <i class="fas fa-chevron-right container-toggle" data-container-id="{{container._id}}"></i>
              {{container.name}}
              <span class="container-info">
                ({{container.contents.length}} {{#if (eq container.contents.length 1)}}item{{else}}items{{/if}}{{#if container.contentsWeight}}, {{container.contentsWeight}}{{#if container.system.containerCapacity}}/{{container.system.containerCapacity}}{{/if}} {{localize 'THIRDERA.Inventory.Lbs'}} inside{{/if}} — {{container.effectiveWeight}} {{localize 'THIRDERA.Inventory.Lbs'}} total{{#if (eq container.system.weightMode "fixed")}} <span class="container-weight-mode-indicator" title="{{localize 'THIRDERA.Container.WeightModeFixed'}}">(fixed)</span>{{/if}})
              </span>
            </h4>
          </div>
          <div class="item-controls">
            <span class="item-detail">Qty: {{container.system.quantity}}</span>
            <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
            <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
          </div>
        </li>
        <li class="container-contents droppable" data-container-id="{{container._id}}" style="display: none;">
          <ol class="items-list container-items">
            {{#each container.contents as |item id|}}
            <li class="item flexrow container-content-item draggable" data-item-id="{{item._id}}" draggable="true">
              <div class="item-name">
                <div class="item-image"><img src="{{item.img}}" title="{{item.name}}" width="24" height="24" /></div>
                <h4>{{item.name}}{{#if (eq item.type 'weapon')}}{{#unless (eq item.system.properties.size "Medium")}}<span class="item-size-label">({{item.system.properties.size}})</span>{{/unless}}{{/if}}{{#if (eq item.type 'armor')}}{{#unless (eq item.system.size "Medium")}}<span class="item-size-label">({{item.system.size}})</span>{{/unless}}{{/if}}</h4>
              </div>
              <div class="item-controls">
                <span class="item-detail">Qty: {{item.system.quantity}} in {{container.name}}</span>
                {{#if (eq item.type 'weapon')}}<span class="item-detail">{{item.system.damage.effectiveDice}}</span>{{/if}}
                {{#if (eq item.type 'armor')}}<span class="item-detail">AC +{{item.system.armor.bonus}}</span>{{/if}}
                <a class="item-remove-container" data-action="removeFromContainer" title="{{localize 'THIRDERA.Container.Remove'}}"><i class="fas fa-box-open"></i></a>
                <a class="item-edit" data-action="editItem" title="Edit Item"><i class="fas fa-edit"></i></a>
                <a class="item-delete" data-action="deleteItem" title="Delete Item"><i class="fas fa-trash"></i></a>
              </div>
            </li>
            {{/each}}
            {{#unless container.contents.length}}
            <li class="container-empty">{{localize 'THIRDERA.Container.Empty'}}</li>
            {{/unless}}
          </ol>
        </li>
        {{/each}}
      </ol>

      <div class="inventory-footer">
        <div class="currency-section" style="flex: 1;">
          <h4 class="items-header">Currency</h4>
          <div class="currency-grid" style="grid-template-columns: repeat(4, 1fr);">
            <div class="currency-item">
              <label title="{{localize 'THIRDERA.Currency.pp'}}">{{localize 'THIRDERA.Currency.ppAbbr'}}</label>
              <input type="number" name="system.currency.pp" value="{{system.currency.pp}}" min="0" data-dtype="Number" />
            </div>
            <div class="currency-item">
              <label title="{{localize 'THIRDERA.Currency.gp'}}">{{localize 'THIRDERA.Currency.gpAbbr'}}</label>
              <input type="number" name="system.currency.gp" value="{{system.currency.gp}}" min="0" data-dtype="Number" />
            </div>
            <div class="currency-item">
              <label title="{{localize 'THIRDERA.Currency.sp'}}">{{localize 'THIRDERA.Currency.spAbbr'}}</label>
              <input type="number" name="system.currency.sp" value="{{system.currency.sp}}" min="0" data-dtype="Number" />
            </div>
            <div class="currency-item">
              <label title="{{localize 'THIRDERA.Currency.cp'}}">{{localize 'THIRDERA.Currency.cpAbbr'}}</label>
              <input type="number" name="system.currency.cp" value="{{system.currency.cp}}" min="0" data-dtype="Number" />
            </div>
          </div>
        </div>
      </div>
    </div>

  </section>
</form>
